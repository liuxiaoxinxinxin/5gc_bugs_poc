# Open5gs - An issue in Open5GS v.2.7.0 allows an attacker to cause a denial of service via the 64 unsuccessful UE/gnb registration
We discovered a logic vulnerability in open5gs using fuzzing, which can cause a crash in the SMF.
The specific causes of the vulnerability are as follows:

## Vulnerability description
When restarting ue/gNB to register, a memory leak in `src/smf/smf-sm.c` from open5gs causing a DoS vulnerability.
### SMF smf-sm
Function `ogs_nnrf_nfm_handle_nf_status_notify` from `src/smf/smf-sm.c` will be called when ue/gNB try to register.

> src/smf/smf-sm.c
```c=95
bool ogs_nnrf_nfm_handle_nf_status_notify(
        ogs_sbi_stream_t *stream, ogs_sbi_message_t *recvmsg)
{
    ...
```
`nf_instance` will be allocated by calling `ogs_sbi_nf_instance_add`.

> lib/sbi/nnrf-handler.c
```c=145
    nf_instance = ogs_sbi_nf_instance_find(message.h.resource.component[1]);
    if (!nf_instance) {
    nf_instance = ogs_sbi_nf_instance_add();
    ogs_assert(nf_instance);

    ogs_sbi_nf_instance_set_id(
    nf_instance, message.h.resource.component[1]);
    ogs_sbi_nf_fsm_init(nf_instance);
    ...
```

`nf_instance` is allocated from `nf_instance_pool` and appended to `nf_instance_list` in `ogs_sbi_nf_instance_add`. 

> lib/sbi/context.c

```c=635
ogs_sbi_nf_instance_t *ogs_sbi_nf_instance_add(void)
{
    ogs_sbi_nf_instance_t *nf_instance = NULL;

    ogs_pool_alloc(&nf_instance_pool, &nf_instance);
    ogs_assert(nf_instance);
    memset(nf_instance, 0, sizeof(ogs_sbi_nf_instance_t));

    OGS_OBJECT_REF(nf_instance);

    nf_instance->time.heartbeat_interval =
            ogs_local_conf()->time.nf_instance.heartbeat_interval;

    nf_instance->priority = OGS_SBI_DEFAULT_PRIORITY;
    nf_instance->capacity = OGS_SBI_DEFAULT_CAPACITY;
    nf_instance->load = OGS_SBI_DEFAULT_LOAD;

    ogs_list_add(&ogs_sbi_self()->nf_instance_list, nf_instance);

    ogs_debug("[%s] NFInstance added with Ref [%s:%d]",
            nf_instance->nf_type ?
                OpenAPI_nf_type_ToString(nf_instance->nf_type) : "NULL",
            nf_instance->id, nf_instance->reference_count);

    return nf_instance;
}
```


Instead of freeing the instances after using or encountering an error, these nodes are freed only after the termination of SMF by calling function `event_termination`.

So making more than 64 unsuccessfu ue/gNB registeration will crash the SMF causing DoS.

### nf_instance_pool

The size of `nf_instance_pool` is defined as 64.

> lib/app/ogs-context.c
```c=175
#define MAX_NUM_OF_UE               1024    /* Num of UEs */
#define MAX_NUM_OF_PEER             64      /* Num of Peer */

    global_conf.max.ue = MAX_NUM_OF_UE;
    global_conf.max.peer = MAX_NUM_OF_PEER;
```
```c=65
static void recalculate_pool_size(void)
{
    ...
    ogs_app()->pool.nf = global_conf.max.peer;
    ...
}
```

> lib/sbi/context.c
```c=51
ogs_pool_init(&nf_instance_pool, ogs_app()->pool.nf);```
```
## POC
The vulnerability can be triggered simply with 64 unsuccessful UE/gnb registration.
The attachment is the relevant log.
```
03/29 16:25:03.062: [sbi] INFO: [AMF] (NRF-notify) NF Profile updated [d72e3776-eda5-41ee-8e08-89c10d90c980:1] (../lib/sbi/nnrf-handler.c:1043)
03/29 16:25:03.608: [smf] WARNING: OLD Session Will Release [SUPI:imsi-001010000000000,PDU Session identity:1] (../src/smf/context.c:1507)
03/29 16:25:03.608: [smf] INFO: Removed Session: UE IMSI:[imsi-001010000000000] DNN:[internet:1] IPv4:[10.45.0.61] IPv6:[] (../src/smf/context.c:1677)
03/29 16:25:03.608: [smf] INFO: [Removed] Number of SMF-Sessions is now 0 (../src/smf/context.c:3098)
03/29 16:25:03.608: [smf] INFO: [Added] Number of SMF-Sessions is now 1 (../src/smf/context.c:3090)
03/29 16:25:03.611: [sbi] WARNING: [UDM] (SCP-discover) NF has already been added [e21bd0b4-eda3-41ee-b0a3-579b3facdebb:1] (../lib/sbi/path.c:216)
03/29 16:25:03.615: [sbi] WARNING: [PCF] (SCP-discover) NF has already been added [e21eeb78-eda3-41ee-ae92-e370f70e741e:1] (../lib/sbi/path.c:216)
03/29 16:25:03.615: [smf] INFO: UE SUPI[imsi-001010000000000] DNN[internet] IPv4[10.45.0.62] IPv6[] (../src/smf/npcf-handler.c:542)
03/29 16:25:03.623: [sbi] WARNING: [UDM] (SCP-discover) NF has already been added [e21bd0b4-eda3-41ee-b0a3-579b3facdebb:2] (../lib/sbi/path.c:216)
03/29 16:25:04.261: [sbi] WARNING: [AMF] (NRF-notify) NF was referenced in other contexts [d72e3776-eda5-41ee-8e08-89c10d90c980:2] (../lib/sbi/nnrf-handler.c:1064)
03/29 16:25:04.948: [sbi] FATAL: ogs_sbi_nf_instance_add: Assertion `nf_instance' failed. (../lib/sbi/context.c:1085)
03/29 16:25:04.949: [core] FATAL: backtrace() returned 9 addresses (../lib/core/ogs-abort.c:37)
/home/lxy/Desktop/open5gs/install/lib/x86_64-linux-gnu/libogssbi.so.2(ogs_sbi_nf_instance_add+0x14c) [0x7fb613c736c2]
/home/lxy/Desktop/open5gs/install/lib/x86_64-linux-gnu/libogssbi.so.2(ogs_nnrf_nfm_handle_nf_status_notify+0xa8f) [0x7fb613c883d5]
./install/bin/open5gs-smfd(+0x26345) [0x55d9f6995345]
/home/lxy/Desktop/open5gs/install/lib/x86_64-linux-gnu/libogscore.so.2(ogs_fsm_dispatch+0x113) [0x7fb613cc9402]
./install/bin/open5gs-smfd(+0x103b3) [0x55d9f697f3b3]
/home/lxy/Desktop/open5gs/install/lib/x86_64-linux-gnu/libogscore.so.2(+0x11754) [0x7fb613cba754]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x8609) [0x7fb612d74609]
/lib/x86_64-linux-gnu/libc.so.6(clone+0x43) [0x7fb612c99353]
```
## Current status
We have reported this vulnerability to the vendor and it has been confirmed, but this bug has not been fixed yet.
